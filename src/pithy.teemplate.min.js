/*
pithy.teemplate.js
teemplate, not template
javascript template parse engine;
by anlige @ 2017-07-23
*/
(function(){var l={trim_start:true,strict:true,escape:false};var c={"\r":true,"\n":true,"\t":true," ":true};var r={"\r":true,"\n":true};var g={"\t":true," ":true};var z={'"':true,"'":true};var v={")":"(","}":"{","]":"["};var w={"(":")","{":"}","[":"]"};var f=[];var p=[];var y=Array.prototype.push;var F=Object.prototype.toString;var e="";var G="__contents";var D="0123456789qwertyuioplkjhgfdsazxcvbnmQWERTYUIOPLKJHGFDSAZXCVBNM_";var E={};var t="+-*/%\\^|&!.?|=:~ <>,";var u={};for(var o=0;o<D.length;o++){e=D.substr(o,1);E[e]=true}for(var o=0;o<t.length;o++){e=t.substr(o,1);u[e]=true}function A(J,H){if(!J||typeof J!="string"){return}var i=function(X,U,Y,W,T){if(X==U){return}var V=U-1;while(V>=X){if(g[Y[V]]){V--}else{break}}H(X,V+1,Y,W,T)};var S=J.split("");var M=S.length;var N=M-1;var L=0;var I="";var O="";var R=0;var Q=true;var P=0;var K="";while(true){I=S[L];if(r[I]){Q=true;P++;i(R,L,S,P,K);R=L+1;K="";if(I=="\r"){if(L<M-1&&S[L+1]=="\n"){L++;R=L+1}}}else{if(Q&&g[I]){K+=I;R++}else{Q=false}}L++;if(L>=M){P++;i(R,L,S,P,K);break}}}var C={IF:"if",FOR:"for",FOREACH:"foreach",EACH:"each",SWITCH:"switch",WHILE:"while",NORMAL:"normal",CODE:"code",HTML:"html",LINE:"line",REGION:"region",ENDREGION:"endregion"};function s(K,L){var J="",i="",I=K.start,H=K.end;while(I<H){i=L[I];if(g[i]&&J==""){I++;continue}if(i==":"){K.start=I+1;K.type=C.LINE;return}if(i=="{"){K.start=I;K.type=C.CODE;return}if(!E[i]){break}J+=L[I];I++}switch(J){case"if":case"for":case"switch":case"while":case"foreach":case"each":case"region":case"endregion":K.start=I;K.type=J;break}}function B(J,H,L){var i=L[J];var K={start:J,end:H,type:"",html_tag:""};if(i=="<"){K.type=C.HTML;var I=J+1;while(I<H){i=L[I];if(i=="/"){K.type=C.HTMLEND;I++;J++;continue}if(!E[i]){break}I++}if(I>J+1){K.html_tag=L.slice(J+1,I).join("")}}else{if(i=="@"){if(J+1==H){throw"syntax error '"+L.slice(J,H).join("")+"'"}K.start++;s(K,L);if(K.type==""){K.type=C.LINE;K.start=J}}else{K.type=C.NORMAL}}return K}function q(O,H,R,I){if(O==H){return[]}var K=H;var J=O;var P="",i="";var N=[];var L="";var M=0;var Q="";while(true){if(J==K){break}i=R[J];if(i=="@"){if(J<K-1&&R[J+1]=="@"){L+="@";J+=2;continue}if(J==K-1){L+="@";break}p.length=0;M=d(J+1,R.length,R,p);if(M>J+1){N.push(G+' += "'+L.replace(/"/g,'\\"')+'";');Q=R.slice(J+1,M).join("");J=M-1;L="";N.push(G+" += "+(I?"__helper.escape(":"")+Q+(I?")":"")+";")}else{L+="@"}}else{L+=i}J++}if(L){N.push(G+' += "'+L.replace(/"/g,'\\"')+'";')}return N}function d(O,I,R,L,Q){var H="",M=false,P=false,i=O,J,N="";Q=Q===true;var K="";while(true){if(O>=I){break}H=R[O];if(!K&&H=="("){K=H}if(z[H]){if(L.length==0){break}if(!M){M=true;i=O;N=H}else{if(M&&R[O-1]!="\\"&&N==H){M=false}}O++;continue}if(M||H=="."){O++;continue}if(w[H]){L.push(H);O++;continue}if(v[H]){if(L.length==0){break}if(L[L.length-1]!=v[H]){J=w[L[L.length-1]];throw'unexpected symbol "'+H+'"'+(J?', expect "'+w[L[L.length-1]]+'"':"")}L.pop();if(!Q){if(L.length==0&&v[H]===K){return ++O}}O++;continue}if(!Q&&u[H]){if(L.length==0){break}O++;continue}if(!Q&&!E[H]){break}O++}if(M){throw"' or \" missing"}if(!Q&&L.length!=0){throw'"'+w[L[L.length-1]]+'" missing'}return O}function n(I,i){var H=typeof I=="string"?document.getElementById(I):I;if(i===undefined){return H?H.innerHTML:""}H&&(H.innerHTML=i)}var m={escape:function(i){if(i===undefined||i===null){return i}i=i+"";if(!i){return}return i.replace(/</g,"&lt;").replace(/>/g,"&gt;")}};function j(M){var I=false,K=M.length,L="",N=[],J="";for(var H=0;H<K;H++){L=M[H];if(L.length>G.length+7&&L.substr(L.length-2)=='";'&&L.substr(0,G.length+5)=='__contents += "'){if(!I){I=true;N.push(L)}else{J=N[N.length-1];J=J.substr(0,J.length-2);J=J+L.substr(G.length+5);N[N.length-1]=J}}else{I=false;N.push(L)}}return N}function x(I,L,i){var K=/^(?:\s*)(.+?)(?:\s*)as(?:\s*)(?:([^\s]+?)(?:,(?:\s*)([^\s]+?))?)(?:\s*)\{$/.exec(I);if(!K){throw"syntax error for 'foreach' statement"}var N=K[1];var H=K[2];var M=K[3];if(!M){M=H;H="__key_"+i}var J=[];if(L==C.EACH){J.push("for(var "+H+"= 0; "+H+" < "+N+".length; "+H+"++){")}else{J.push("for(var "+H+" in "+N+"){");J.push("if(!"+N+".hasOwnProperty("+H+")) continue;")}J.push("var "+M+" = "+N+"["+H+"];");return J.join("\n")}function h(I,i){var H=i.length;return I.length>=H&&I.substr(I.length-H)==i}function b(){for(var i in l){if(!l.hasOwnProperty(i)){continue}this.config(i,l[i])}}b.prototype.config=function(i,H){if(b.prototype[i]){throw"Exception: can not modify property '"+i+"'";return}this[i]=H};b.prototype.compile=function(I){var O=[];var i=0;O.push("var "+G+" = '';");if(!this.strict){O.push("with($){")}I=I.replace(/^([\r\n]+)/,"");f.length=0;function K(Q,S,R){return"Exception : "+Q+"\nLine: "+i+"\nCode: "+R}var P=this.trim_start,J=this.escape,L="",M=0,N=0,H=false;A(I,function(X,T,Y,V,S){i=V;var Q=null;var U=I.slice(X,T);try{Q=B(X,T,Y)}catch(R){throw K(R,X,U)}var W=I.slice(Q.start,Q.end);switch(Q.type){case C.REGION:H=true;break;case C.ENDREGION:H=false;break;case C.FOREACH:case C.EACH:try{W=x(W,Q.type,i)}catch(R){if(typeof R=="string"){throw K(R,X,U)}throw R}Q.type="";case C.IF:case C.FOR:case C.SWITCH:case C.WHILE:W=Q.type+W;case C.NORMAL:case C.CODE:if(!H){try{d(Q.start,Q.end,Y,f,true)}catch(R){if(typeof R=="string"){throw K(R,X,U)}throw R}L=U;M=V;N=X;O.push(W);break}case C.HTML:case C.HTMLEND:case C.LINE:try{if(!P&&S){O.push(G+' += "'+S+'";')}y.apply(O,q(Q.start,Q.end,Y,J));O.push(G+' += "\\n";')}catch(R){if(typeof R=="string"){throw K(R,X,U)}throw R}break}});if(f.length!=0){i=M;throw K('"'+w[f[f.length-1]]+'" missing',N,L)}if(!this.strict){O.push("}")}O.push("return "+G+";");O=j(O);return O.join("\r\n")};b.prototype.render=function(i,H){if(!H||F.call(H)!="[object Object]"){throw"Exception : data is invalid. it must be an objected-type."}if(!this.strict){return(new Function("$","__helper",i))(H,m)}var J=[];var K=[];for(var I in H){if(!H.hasOwnProperty(I)){continue}J.push(I);K.push(H[I])}J.push("__helper");K.push(m);var L=new Function(J,i);return L.apply(null,K)};var k=null;b.compile=function(i){if(k==null){k=new b()}return k.compile(i)};b.render=function(i,H){if(k==null){k=new b()}return k.render(i,H)};b.execute=function(I){var L=I.getElementsByTagName("script");if(L.length==0){return}var K=null;for(var J=0;J<L.length;J++){K=L[J];if(K.src){var H=document.createElement("script");H.src=K.src;K.parentNode.replaceChild(H,K)}else{(new Function(K.innerHTML))()}}};m.typeOf=b.typeOf=function(i){return F.call(i)};b.config=function(i,H){i=="trim_start"&&(l[i]=H!==false);i=="trim_start"&&(l[i]=H!==false);i=="escape"&&(l[i]=H!==false)};var a={};b.bind=function(H,M,I){var J=typeof M=="string";var i="";var K=new b();if(J&&a[M]){i=a[M]}else{i=n(M);if(!i){return""}i=K.compile(i);if(J){a[M]=i}}var L=K.render(i,H);if(typeof I=="function"){I(L)}else{n(I,L)}};window.Pjt=b})();